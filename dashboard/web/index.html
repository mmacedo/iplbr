<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Dashboard</title>

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/favicons/manifest.json">
  <link rel="shortcut icon" href="/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  <meta name="msapplication-config" content="/favicons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1">

  <!-- http://bootswatch.com/journal/ -->
  <link href="css/bootstrap-3.3.5.min.css" rel="stylesheet">
  <link href="css/led.css" rel="stylesheet">

  <style type="text/css">
    .navbar-static-top { margin-bottom: 0; }
    @media (min-width: 768px) {
      .nav > .show-button > a { padding-right: 70px; }
      .nav > .open-button > a { margin-left: -65px; }
      .nav > .refresh-button > a { margin-left: -40px; }
      .nav > .open-button > a,
      .nav > .refresh-button > a {
        width: 25px;
        font-size: 75%;
        padding-left: 5px; padding-right: 5px;
      }
    }
    .tab { display: none; }
    .tab.active { display: block; }
    iframe {
      width: 100%;
      min-height: 400px;
      background-color: transparent;
      border: 0px none transparent;
      padding: 0px;
      overflow: hidden;
    }
  </style>

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>
  <nav class="navbar navbar-default navbar-static-top">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a id="brand" class="navbar-brand" href="">
          <img alt="Brand" width="20" height="20" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAQAAAAm93DmAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAHdElNRQffBxYDJzeI0Hk6AAAC50lEQVRIx%2B3Wb2jVZRQH8M%2B9bnebzRSMJTXDJULM6kUEoxglUS9qRBBRrRdRwSJI7A%2BuAilagygI%2BvMmo0ZgEGpSZn%2BUFaUUmBKEWjNChSJXm%2BVqbrbt7t6nF3u63bv7u3eL3pXneXW%2Bz3m%2B9zzne57zu5yx/76l5hWVlkaQ%2B3eENc7XarUW56iTMuUXR31jwKDsP818qVu96agJYdaacMxmnZrmn%2BFiN7vXZTLRD3Y6jIvcUIjPOuA1W43MXYIrfGCyJKecTnCbXAk%2BpV97dRUyuvxYdslKhEEw6D51legaPOl02ZFKhHmjcoJxPRqS6Or0OuVzm2wxUHI0mXCv6%2B0QBJN6y7NMWWvIAxYhbbmNskW59OnS5VX5AvaFi7Hc%2B4LgtHWza3mNYS%2BrKfiLPDdLmlCS3SXxVi9EZMh1xXRN9sjqKPmJhZ5O6MKZK94J6j1VFPGZc/8%2BvF7euKsL4qzSiAY9/kikPKhNXQldkPfoX3QrHBYEa6P/iCGvW4Z6TyTqHhzQV7bzrZYZgnWx2F9ZCV4U5L2tGXU2VKBMWg/OPLRPCsAbGrHa14LgPRcg4zHjVWmmjMWUdlvCVX4t2uqWwo1OCIKdViCj21gC0YitnnG/Dp1OCoKT1rChqLuCEzqQtj42zS4tqPWwU2WEhwoTp9mRKMzjvFOmYCvO0hf9/kh5j37DJZHHrSrMp30R2yHWq3i9ayma7Yn%2BRy6MfXe5TUWtMu4u7W7X7RVDERvg54Rh8KxatDkWkY%2Bj/izUW3hBeaPGZ02gYX5LKPeYu8Edfo/Ip26yDDR6q4rio0kZBsEP2lGjx3ShA/ZqA9cmCFSUYaUhsN9KLLGtCNulEU0OVaCb9HzK2W5xqVppKWmpOIZSFthuO670ocWxgsetcUTGQ1pNCxCrGeRlHbSt2gchDc6LLz0IvtNsDktX2cuDn2wxDXI2G5yLcMFcAfjSiIzvbfSSybmC5/dXJKUeE7FqZ%2Bx/b38CY9Ew6Z20fb4AAAAldEVYdGRhdGU6Y3JlYXRlADIwMTUtMDctMjJUMDA6Mzk6NDItMDM6MDCanIgLAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE1LTA3LTIyVDAwOjM5OjQyLTAzOjAw68EwtwAAAABJRU5ErkJggg%3D%3D" />
        </a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
        </ul>
      </div>
    </div>
  </nav>

  <div id="content">
  </div>

  <script src="js/jquery-1.11.3.min.js"></script>
  <script src="js/bootstrap-3.3.5.min.js"></script>
  <script src="js/ie10-viewport-bug-workaround.js"></script>
  <script src="js/iframeResizer.min.js"></script>
  <script src="js/lodash-3.10.0.min.js"></script>

  <script type="text/javascript">
    jQuery(function($) {
      $.getJSON('/tabs.json').done(function(json) {
        var $nav  = $('#navbar > ul.nav').empty();
        var $tabs = $('#content').empty();
        var navTmpl = _.template(
          '<li class="show-button" id="show_<%- id %>">' +
          '<a href="#<%- id %>"><span class="led led-yellow"></span> <%- title %></a>' +
          '</li>' +
          '<li class="open-button" id="open_<%- id %>">' +
          '<a href="<%- url %>" target="_new"><span class="glyphicon glyphicon-new-window"></span></a>' +
          '</li>' +
          '<li class="refresh-button" id="refresh_<%- id %>">' +
          '<a href=""><span class="glyphicon glyphicon-refresh"></span></a>' +
          '</li>');
        var tabTmpl = _.template(
          '<div id="<%- id %>" class="tab">' +
          '<iframe scrolling="no"></iframe>' +
          '</div>');
        _.each(json, function(value, key) {
          // Add tab
          var title = key, id = _.kebabCase(title), url = value;
          var context = { id: id, title: title, url: url };
          $nav.append(navTmpl(context));
          $tabs.append(tabTmpl(context));

          var $iframe = $('#' + id + ' > iframe');
          var $led    = $('#show_' + id + ' .led');

          var updateLed = _.debounce(function updateLed() {
            var colour = !$iframe.data('loaded') ?
              'yellow' :
              $iframe.data('messaged') ? 'green' : 'red';
            $led.attr('class', 'led led-' + colour);
          }, 100);

          function reloadIframe() {
            $iframe.load(function() {
              $iframe.data('loaded', true);
              updateLed();
            }).attr('src', url);
            iFrameResize();
          }

          // Loaded iframe content
          $(window).on('message', function(e) {
            if (e.originalEvent.origin === url) {
              $iframe.data('messaged', true);
              updateLed();
            }
          });

          // Refresh button
          $('#refresh_' + id).click(function() {
            $led.attr('class', 'led led-yellow');
            var active = $('#' + id).replaceWith(tabTmpl(context)).hasClass('active');
            $iframe = $('#' + id + ' > iframe');
            reloadIframe();
            if (active) {
              $('#' + id).addClass('active');
            }
            return false;
          });

          reloadIframe();
        });

        function showTab(tab) {
          $('.tab').removeClass('active');
          $('#navbar .show-button').removeClass('active');
          if (tab != null) {
            $('#' + tab).addClass('active');
            return $('#show_' + tab).addClass('active').find('a').text();
          }
          return null;
        }

        $(document).on('click', '#brand', function(e) {
          if (e.ctrlKey === true || e.shiftKey === true) {
            return;
          }
          showTab(null);
          history.pushState({ tab: null }, 'Dashboard', $('#brand').attr('href'));
        });

        $(document).on('click', '#navbar > .nav > .show-button > a', function(e) {
          if (e.ctrlKey === true || e.shiftKey === true) {
            return;
          }
          var hash = $(this).attr('href'), tab = hash.slice(1);
          history.pushState({ tab: tab }, showTab(tab), hash);
          // Not good if you are changing tabs often
          return false;
        });

        if (history.state == null) {
          var hash = window.location.hash ? window.location.hash.replace(/^#/, '') : '';
          var state = { tab: hash || null };
          var title = showTab(state.tab);
          if (hash.length > 0) {
            history.replaceState(state, title, '#' + hash);
          } else {
            history.replaceState(state, title);
          }
        } else {
          showTab(history.state.tab);
        }

        window.onpopstate = function(e) {
          if (e.state == null) {
            return;
          }
          showTab(e.state.tab);
        };

      });
    });
  </script>
</body>
</html>
